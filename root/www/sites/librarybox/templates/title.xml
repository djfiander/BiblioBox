<?xml version="1.0" encoding="UTF-8"?>
<%!
    import sqlite3

    works_query = """SELECT au.author_name as author,
                            w.citation as title,
		            w.description as descr,
                            w.work_id as work_id,
                            w.uuid as uuid,
		            w.cover as cover,
		            cf.format_type as cover_fmt
                     FROM authors au, works w, work_authors wa, formats cf
                     WHERE wa.work_id = wa.author_id
		           AND cf.format_id = w.cover_fmt
                     ORDER BY w.sort_title"""

    books_query = """SELECT f.format_type as ftype,
		            b.filename as fname
		     FROM books b, formats f
	             WHERE b.work_id = ?
	                   AND b.format_id = f.format_id
                     ORDER BY b.format_id"""
%>
<feed xmlns="http://www.w3.org/2005/Atom"
      xmlns:dc="http://purl.org/dc/terms/"
      xmlns:opds="http://opds-spec.org/2010/catalog">
  <id>urn:uuid:433a5d6a-0b8c-4933-af65-4ca4f02763eb</id>
 
  <link rel="self"    
        href="/catalogue.py?title.xml"
        type="application/atom+xml;profile=opds-catalog;kind=acquisition" />
  <link rel="start"
	href="/catalogue.py?root.xml"
	type="application/atom+xml;profile=opds-catalogue;kind=navigation" />
  <link rel="up"
	href="/catalogue.py?root.xml"
	type="application/atom+xml;profile=opds-catalogue;kind=navigation" />

  <title>Browse by Title</title>
  <updated>2012-05-24T12:48:00Z</updated>
  <author>
    <name>David Fiander</name>
  </author>
  <%
      conn = sqlite3.connect("/www/sites/librarybox/data/librarybox.db")
      conn.row_factory = sqlite3.Row
      conn.text_factory = str

      works = conn.cursor()
      works.execute(works_query)
  %>

% for work in works:
  <entry>
    <title>${work['title']}</title>
    <id>urn:uuid:${work['uuid']}</id>
    <updated>2012-05-24T12:48:00Z</updated>
    <author>
      <name>${work['author']}</name>
    </author>
    <dc:language>en</dc:language>
    % if work['descr']:
    <summary>${work['descr']}</summary>
    % endif
    % if work['cover']:
    <link rel="http://opds-spec.org/image"     
          href="${work['cover']|u}"
          type="${work['cover_fmt']}"/> 
    % endif

    <%
        books = conn.cursor()
	t = (work['work_id'],)
	books.execute(books_query, t)
    %>

    % for book in books:
        <link rel="http://opds-spec.org/acquisition" 
              href="${book['fname']|u}"
              type="${book['ftype']}"/>
    % endfor
    <%
        books.close()
    %>
  </entry>
% endfor
<%
    works.close()
    conn.close()
%>
</feed>
