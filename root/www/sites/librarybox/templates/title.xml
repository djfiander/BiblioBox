<?xml version="1.0" encoding="UTF-8"?>
<%!
    import sqlite3

    query = """SELECT au.author_name as author,
                      w.citation as title,
		      w.description as descr,
		      b.id as book_id,
		      b.uuid as uuid,
		      formats.format_name as format,
		      formats.format_type as ftype,
		      b.filename as fname,
		      b.cover as cover,
		      cf.format_type as cover_fmt
               FROM authors au, works w, work_authors wa, books b,
                    formats, formats cf
               WHERE wa.work_id = wa.author_id
	             AND b.work_id = w.work_id
		     AND formats.format_id = b.format_id
		     AND cf.format_id = b.cover_fmt
               ORDER BY w.sort_title"""
%>
<feed xmlns="http://www.w3.org/2005/Atom"
      xmlns:dc="http://purl.org/dc/terms/"
      xmlns:opds="http://opds-spec.org/2010/catalog">
  <id>urn:uuid:433a5d6a-0b8c-4933-af65-4ca4f02763eb</id>
 
  <link rel="self"    
        href="/catalogue.py?title.xml"
        type="application/atom+xml;profile=opds-catalog;kind=acquisition" />
  <link rel="start"
	href="/catalogue.py?root.xml"
	type="application/atom+xml;profile=opds-catalogue;kind=navigation" />
  <link rel="up"
	href="/catalogue.py?root.xml"
	type="application/atom+xml;profile=opds-catalogue;kind=navigation" />

  <title>Browse by Title</title>
  <updated>2012-05-24T12:48:00Z</updated>
  <author>
    <name>David Fiander</name>
  </author>
  <%
      conn = sqlite3.connect("/www/sites/librarybox/data/librarybox.db")
      conn.row_factory = sqlite3.Row
      conn.text_factory = str
      c = conn.cursor()
      c.execute(query)
  %>

% for entry in c:
  <entry>
    <title>${entry['title']}</title>
    <id>urn:uuid:${entry['uuid']}</id>
    <updated>2012-05-24T12:48:00Z</updated>
    <author>
      <name>${entry['author']}</name>
    </author>
    <dc:language>en</dc:language>
    % if entry['descr']:
    <summary>${entry['descr']}</summary>
    % endif
    % if entry['cover']:
    <link rel="http://opds-spec.org/image"     
          href="${entry['cover']|u}"
          type="${entry['cover_fmt']}"/> 
    % endif
    <link rel="http://opds-spec.org/acquisition" 
          href="${entry['fname']|u}"
          type="${entry['ftype']}"/>
  </entry>
% endfor
<%
    conn.close()
%>
</feed>
